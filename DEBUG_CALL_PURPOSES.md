# Отладка проблемы с сохранением целей звонков

## Проблема

При нажатии на кнопку "Сохранить информацию" ничего не происходит, сохранение описания звонка не работает.

## Шаги для отладки

### 1. Проверка базы данных

Выполните тестовый скрипт `db/test_call_purposes.sql` в вашей базе данных:

```sql
-- Проверяем существование таблицы call_purposes
SELECT EXISTS (
    SELECT FROM information_schema.tables
    WHERE table_schema = 'public'
    AND table_name = 'call_purposes'
) as table_exists;

-- Проверяем существование полей в таблице calls
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'calls'
AND column_name IN ('purpose_id', 'description', 'updated_at');

-- Проверяем данные в таблице call_purposes
SELECT * FROM call_purposes;

-- Проверяем последние записи в таблице calls
SELECT id, caller_number, receiver_number, purpose_id, description, updated_at
FROM calls
ORDER BY id DESC
LIMIT 5;
```

### 2. Проверка консоли браузера

1. Откройте Developer Tools (F12)
2. Перейдите на вкладку Console
3. Откройте модальное окно звонка
4. Нажмите кнопку "Сохранить информацию"
5. Проверьте логи в консоли

### 3. Проверка логов сервера

1. Откройте терминал с запущенным CRM сервером
2. Нажмите кнопку "Сохранить информацию" в браузере
3. Проверьте логи сервера на наличие ошибок

### 4. Проверка API endpoints

Протестируйте API endpoints напрямую:

#### Получение целей звонков:

```bash
curl http://localhost:5004/api/call-purposes
```

#### Получение деталей звонка (замените {callId} на реальный ID):

```bash
curl http://localhost:5004/api/calls/{callId}/details
```

#### Обновление звонка (замените {callId} на реальный ID):

```bash
curl -X PUT http://localhost:5004/api/calls/{callId} \
  -H "Content-Type: application/json" \
  -d '{"purpose_id": 1, "description": "Тестовое описание"}'
```

## Возможные причины проблемы

### 1. Не выполнены SQL скрипты

Если таблицы `call_purposes` или поля в `calls` не существуют:

- Выполните скрипт `db/call_purposes.sql`
- Перезапустите сервер

### 2. Неправильный ID звонка

Проверьте, что в `callData` передается правильный ID звонка:

- Откройте консоль браузера
- Проверьте логи при открытии модального окна
- Убедитесь, что `callId` не undefined

### 3. Ошибки в API

Проверьте логи сервера на наличие ошибок:

- Ошибки подключения к базе данных
- Ошибки в SQL запросах
- Ошибки валидации данных

### 4. CORS ошибки

Проверьте, что нет ошибок CORS в консоли браузера.

## Что добавлено для отладки

### В клиентской части:

- Подробное логирование в консоль браузера
- Проверка различных полей для ID звонка (`callId`, `id`, `call_id`)
- Уведомления пользователю о результатах операций
- Обработка ошибок с выводом в alert

### В серверной части:

- Логирование всех входящих запросов
- Проверка существования звонка перед обновлением
- Подробные сообщения об ошибках
- Логирование результатов SQL запросов

## Ожидаемые логи

### В консоли браузера:

```
callData изменился: {type: "call_ended", callId: 123, ...}
Найден ID звонка: 123
Загружаем детали звонка для ID: 123
Ответ от сервера: 200
Полученные данные звонка: {id: 123, purpose_id: null, description: null, ...}
Начинаем сохранение данных звонка...
Отправляем запрос: {url: "http://localhost:5004/api/calls/123", method: "PUT", body: {...}}
Получен ответ: 200 OK
Данные звонка успешно сохранены: {id: 123, purpose_id: 1, description: "Тест", ...}
```

### В логах сервера:

```
Получен запрос на получение деталей звонка: 123
Выполняем запрос: SELECT ... WHERE c.id = $1 [123]
Результат запроса: [{id: 123, purpose_id: null, description: null, ...}]
Получен запрос на обновление звонка: {callId: "123", purpose_id: 1, description: "Тест"}
Выполняем запрос: UPDATE calls SET ... WHERE id = $3 [1, "Тест", 123]
Результат обновления: {id: 123, purpose_id: 1, description: "Тест", ...}
```

## Следующие шаги

1. Выполните все проверки выше
2. Если проблема не решена, предоставьте:
   - Логи из консоли браузера
   - Логи сервера
   - Результаты выполнения тестового SQL скрипта
   - Скриншот ошибок в Developer Tools
