# Исправление проблемы с отображением "Вызов завершен"

## Проблема

Когда звонок был принят (стал активным), а затем завершен, не отображалось модальное окно "Вызов завершен". Вместо этого клиент получал повторное уведомление `call_started` вместо `call_ended`.

## Причина

После события `Hangup` (завершение звонка) Asterisk отправлял дополнительные события (`DialStatus: ANSWER`, `Event: Bridge`, `Event: Answer`) для того же канала, которые перезаписывали состояние звонка и отправляли уведомление о начале разговора вместо завершения.

## Внесенные исправления

### Добавлены проверки в обработчики событий:

1. **Event: Answer** - добавлена проверка `currentCall.callProcessed`
2. **DialStatus: ANSWER** - добавлена проверка `currentCall.callProcessed`
3. **Event: Bridge** - добавлена проверка `currentCall.callProcessed`

### Логика проверки:

```javascript
if (currentCall.callProcessed) {
  console.log(
    `Ignoring [Event] for already processed call on channel: ${currentCall.channel}`
  );
  return;
}
```

## Инструкция по применению

### 1. Перезапуск Asterisk сервера

```bash
cd server/asterisk_server
node Asterisk.js
```

### 2. Тестирование исправления

#### Сценарий 1: Активный звонок → Завершение

1. Откройте консоль браузера (F12)
2. Совершите входящий звонок
3. Примите звонок (должно появиться "Активный звонок")
4. Завершите звонок
5. **Ожидаемый результат**: Должно появиться модальное окно "Вызов завершен"

#### Сценарий 2: Пропущенный звонок

1. Совершите входящий звонок
2. Не принимайте звонок
3. Дождитесь завершения
4. **Ожидаемый результат**: Должно появиться модальное окно "Вызов завершен"

### 3. Проверка логов

#### В консоли Asterisk сервера должны появиться:

```
=== sendCallEndedNotification вызвана ===
callData: { ... }
callId: [число]
Отправляем уведомление call_ended: { ... }
Отправлено уведомление о завершении звонка для пользователя [ID]
Уведомление о завершении звонка отправлено
Call already processed for channel: [channel]
Ignoring DialStatus: ANSWER for already processed call on channel: [channel]
```

#### В консоли браузера должны появиться:

```
=== ПОЛУЧЕНО УВЕДОМЛЕНИЕ О ЗАВЕРШЕНИИ ЗВОНКА ===
callData: { ... }
Текущий currentCall перед обновлением: { ... }
Устанавливаем currentCall для завершенного звонка: { ... }
currentCall обновлен на завершенный звонок
```

## Ожидаемый результат

После завершения активного звонка должно появиться модальное окно "Вызов завершен" с возможностью:

- Выбора цели звонка
- Ввода описания
- Сохранения информации о звонке

## Дополнительные проверки

### Проверка в базе данных:

```sql
SELECT id, caller_number, receiver_number, status, purpose_id, description, accepted_at
FROM calls
ORDER BY id DESC
LIMIT 5;
```

Убедитесь, что:

- Записи создаются при начале звонка (status = "accepted")
- Поля `purpose_id` и `description` заполняются при сохранении
- Нет дублирующих записей для одного звонка

## Возможные проблемы

### Если проблема не решена:

1. Проверьте, что Asterisk сервер перезапущен с новым кодом
2. Проверьте логи на наличие ошибок
3. Убедитесь, что WebSocket соединения активны
4. Проверьте, что CRM сервер также перезапущен

### Если появляются ошибки:

1. Проверьте консоль Asterisk сервера на ошибки базы данных
2. Проверьте консоль браузера на ошибки сети
3. Убедитесь, что все серверы запущены и доступны
