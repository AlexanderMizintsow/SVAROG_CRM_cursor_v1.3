# Исправление проблемы с ID звонка

## Проблема

При попытке сохранить информацию о звонке (цель и описание) возникала ошибка "ID звонка не найден", потому что в данных уведомлений о звонках отсутствовало поле `callId`.

## Внесенные изменения

### 1. Серверная часть (server/asterisk_server/Asterisk.js)

#### Изменения в логике создания записей звонков:

- **Создание записи при начале звонка**: Теперь запись в таблице `calls` создается при первом событии принятия звонка (Answer, Bridge, Unlink), а не только при завершении
- **ID звонка сохраняется в currentCall**: ID созданной записи сохраняется в объекте `currentCall.callId`
- **Обновление при завершении**: При завершении звонка существующая запись обновляется, а не создается новая

#### Изменения в функциях уведомлений:

- **sendCallStartedNotification**: Теперь включает `callId` в данные уведомления
- **sendCallEndedNotification**: Теперь принимает `callId` как параметр и включает его в данные уведомления

### 2. Структура данных уведомлений

Теперь данные уведомлений содержат:

```javascript
{
  type: "call_started" | "call_ended",
  callId: 123, // ID записи в таблице calls
  receiverUserId: 456,
  receiverName: "Имя Получателя",
  callerNumber: "+1234567890",
  callerName: "Имя Звонящего",
  callerType: "user" | "dealer" | "unknown",
  receiverNumber: "+0987654321",
  timestamp: "2024-01-01T12:00:00.000Z",
  channel: "SIP/1234-00000001",
  duration: 120 // только для call_ended
}
```

## Инструкция по применению

### 1. Перезапуск сервера Asterisk

```bash
cd server/asterisk_server
npm restart
# или
node Asterisk.js
```

### 2. Тестирование функциональности

#### Шаг 1: Проверка создания записи при начале звонка

1. Совершите входящий звонок
2. Примите звонок
3. Проверьте в консоли сервера сообщение: `Call record created with ID: [число]`

#### Шаг 2: Проверка ID в уведомлении

1. Откройте консоль браузера (F12)
2. При входящем звонке проверьте в консоли данные `callData`
3. Убедитесь, что поле `callId` присутствует и содержит числовое значение

#### Шаг 3: Тестирование сохранения цели и описания

1. При активном звонке выберите цель звонка
2. Введите описание
3. Нажмите "Сохранить информацию"
4. Проверьте, что появляется уведомление "Информация о звонке успешно сохранена!"

### 3. Проверка в базе данных

Выполните SQL запрос для проверки:

```sql
SELECT id, caller_number, receiver_number, purpose_id, description, status, accepted_at
FROM calls
ORDER BY id DESC
LIMIT 5;
```

Убедитесь, что:

- Записи создаются при начале звонка (status = "accepted")
- Поля `purpose_id` и `description` заполняются при сохранении

## Возможные проблемы и решения

### Проблема: Запись не создается при начале звонка

**Решение**: Проверьте логи сервера на наличие ошибок базы данных

### Проблема: ID звонка все еще не найден

**Решение**:

1. Проверьте, что сервер Asterisk перезапущен
2. Проверьте консоль браузера на наличие поля `callId` в `callData`
3. Убедитесь, что WebSocket соединение активно

### Проблема: Сохранение не работает

**Решение**:

1. Проверьте, что CRM сервер запущен на порту 5004
2. Проверьте, что таблицы `call_purposes` и поля в `calls` созданы
3. Проверьте консоль браузера на ошибки сети

## Логи для отладки

### Сервер Asterisk

- `Call record created with ID: [число]` - успешное создание записи
- `Call record updated with ID: [число]` - успешное обновление записи
- `Database error when creating call record: [ошибка]` - ошибка базы данных

### Клиент (консоль браузера)

- `callData изменился: [объект]` - получение данных звонка
- `Найден ID звонка: [число]` - успешное извлечение ID
- `Данные звонка успешно сохранены: [объект]` - успешное сохранение
