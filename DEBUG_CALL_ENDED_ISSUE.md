# Отладка проблемы с отображением "Вызов завершен"

## Проблема

Когда звонок был принят (стал активным), а затем завершен, не отображается модальное окно "Вызов завершен". Модальное окно "Вызов завершен" отображается только для пропущенных звонков.

## Добавленное логирование

### 1. Сервер Asterisk (server/asterisk_server/Asterisk.js)

- Логирование вызова функции `sendCallEndedNotification`
- Логирование данных звонка и ID
- Логирование отправки уведомления через WebSocket

### 2. CRM Сервер (server/CRM-server/index.js)

- Логирование получения уведомления `call_ended`
- Логирование поиска пользователя в подключениях
- Логирование отправки уведомления клиенту

### 3. Клиент (client/src/hooks/useCallNotifications.js)

- Подробное логирование получения уведомления `call_ended`
- Логирование состояния `currentCall` до и после обновления

## Инструкция по тестированию

### Шаг 1: Перезапуск серверов

```bash
# Перезапустите Asterisk сервер
cd server/asterisk_server
node Asterisk.js

# Перезапустите CRM сервер
cd server/CRM-server
node index.js

# Перезапустите клиентское приложение
cd client
npm run dev
```

### Шаг 2: Тестирование сценария

1. Откройте консоль браузера (F12)
2. Совершите входящий звонок
3. Примите звонок (должно появиться "Активный звонок")
4. Завершите звонок
5. Проверьте логи в консоли браузера и серверов

### Шаг 3: Проверка логов

#### В консоли Asterisk сервера должны появиться:

```
=== sendCallEndedNotification вызвана ===
callData: { ... }
callId: [число]
Отправляем уведомление call_ended: { ... }
Отправлено уведомление о завершении звонка для пользователя [ID]
```

#### В консоли CRM сервера должны появиться:

```
Получено уведомление о завершении звонка: { ... }
Отправляем call_ended пользователю [ID] на socket [socket_id]
call_ended отправлен успешно
```

#### В консоли браузера должны появиться:

```
=== ПОЛУЧЕНО УВЕДОМЛЕНИЕ О ЗАВЕРШЕНИИ ЗВОНКА ===
callData: { ... }
Текущий currentCall перед обновлением: { ... }
Устанавливаем currentCall для завершенного звонка: { ... }
currentCall обновлен на завершенный звонок
```

## Возможные причины проблемы

### 1. WebSocket соединение разорвано

**Признаки**: Нет логов в CRM сервере о получении `call_ended`
**Решение**: Проверьте подключение к WebSocket

### 2. Пользователь не найден в подключениях

**Признаки**: Лог "Пользователь [ID] не найден в подключениях для call_ended"
**Решение**: Проверьте аутентификацию пользователя

### 3. Клиент не получает уведомление

**Признаки**: Есть логи в CRM сервере, но нет в браузере
**Решение**: Проверьте WebSocket соединение клиента

### 4. Состояние не обновляется

**Признаки**: Есть логи в браузере, но модальное окно не меняется
**Решение**: Проверьте логику компонента CallNotification

## Дополнительная отладка

### Проверка WebSocket соединения

В консоли браузера выполните:

```javascript
// Проверьте состояние WebSocket
console.log(window.socket || "WebSocket не найден");
```

### Проверка состояния компонента

В компоненте CallNotification добавьте:

```javascript
useEffect(() => {
  console.log("CallNotification: callData изменился", callData);
}, [callData]);
```

## Ожидаемый результат

После завершения активного звонка должно появиться модальное окно "Вызов завершен" с возможностью сохранения цели и описания звонка.
