# Система уведомлений о звонках в реальном времени

## Описание

Система уведомлений о звонках позволяет пользователям получать уведомления в реальном времени о входящих звонках на их номера телефонов. Система интегрирована с Asterisk и автоматически определяет звонящих по базе данных пользователей и дилеров.

## Логика работы

### Основной принцип:

1. **Определение получателя звонка**: Система ищет пользователя в таблице `user_phones` по номеру, на который поступает звонок
2. **Определение звонящего**: Система ищет звонящего в таблицах `user_phones` и `dealer_phone_numbers`
3. **Отправка уведомлений**: Уведомления отправляются только пользователю, которому принадлежит номер получателя
4. **Отслеживание статуса**: Система отслеживает входящий звонок → начало разговора → завершение звонка

### События Asterisk:

- **Event: Newchannel** - начало нового звонка
- **CallerIDNum** - номер звонящего
- **Exten** - номер, на который звонят
- **Event: Dial** - событие набора номера (отправка уведомления о входящем звонке)
- **Event: Answer** - звонок принят (начало разговора)
- **Event: Hangup** - завершение звонка

## Архитектура

### Серверная часть

1. **Asterisk.js** - основной сервер для обработки событий Asterisk

   - Подключается к Asterisk AMI
   - Отслеживает события звонков (Newchannel, Answer, Hangup)
   - Определяет пользователей и дилеров по номерам телефонов
   - Отправляет уведомления через WebSocket

2. **CRM-server** - сервер для обработки WebSocket соединений

   - Управляет подключениями пользователей
   - Перенаправляет уведомления конкретным пользователям
   - Обрабатывает аутентификацию пользователей

### Клиентская часть

1. **useCallNotifications** - хук для управления уведомлениями

   - Подключение к WebSocket серверу
   - Обработка событий звонков
   - Воспроизведение звуковых уведомлений

2. **CallNotification** - компонент модального окна

   - Отображение информации о звонке
   - Информационные сообщения вместо кнопок управления
   - Таймер для активных звонков

## Исправления в системе

### Серверная часть (Asterisk.js):

1. **Убрано дублирование уведомлений** - уведомления отправляются только при событии `Event: Dial`
2. **Улучшена логика определения получателя** - система корректно определяет пользователя по номеру получателя
3. **Улучшена логика статусов** - статус определяется по наличию `receiverNumber`
4. **Добавлена проверка принадлежности номеров** - система проверяет, что номер действительно принадлежит пользователю

### Клиентская часть:

1. **Упрощен интерфейс** - убраны кнопки "Ответить" и "Отклонить"
2. **Добавлены информационные сообщения**:
   - "Необходимо взять трубку" для входящих звонков
   - "Разговор активен" для активных звонков
   - "Звонок завершен" для завершенных звонков
3. **Улучшена логика отображения** - модальное окно остается открытым после завершения звонка
4. **Добавлен таймер** - отображение длительности активного звонка

## Таблицы базы данных

### Основные таблицы:

1. **users** - пользователи системы
2. **user_phones** - номера телефонов пользователей
3. **dealers** - дилеры
4. **dealer_phone_numbers** - номера телефонов дилеров
5. **companies** - компании дилеров
6. **calls** - история звонков

### Пример добавления номера пользователя:

```sql
INSERT INTO user_phones (user_id, phone_number, phone_type)
VALUES (1, '89271390907', 'мобильный');
```

## Настройка системы

### Требования:

1. **Asterisk сервер** с настроенным AMI
2. **PostgreSQL база данных** с таблицами пользователей и дилеров
3. **CRM сервер** на порту 5004
4. **Клиентское приложение** с настроенными WebSocket соединениями

### Конфигурация:

1. **Asterisk.js** - настройка подключения к AMI
2. **CRM-server** - настройка WebSocket сервера
3. **Клиент** - настройка подключения к WebSocket

## Тестирование

### Тестовый скрипт:

```bash
node server/test-call-system.js
```

Скрипт симулирует полный цикл звонка:

1. Входящий звонок
2. Начало разговора
3. Завершение звонка

### Проверка работы:

1. Запустить CRM сервер
2. Открыть клиентское приложение
3. Авторизоваться пользователем с номером телефона
4. Запустить тестовый скрипт
5. Проверить появление уведомлений

## Интеграция

Система интегрирована в существующий CRM проект и использует его архитектуру и зависимости.

### Файлы:

- `server/asterisk_server/Asterisk.js` - сервер Asterisk
- `server/CRM-server/index.js` - CRM сервер
- `client/src/hooks/useCallNotifications.js` - хук уведомлений
- `client/src/components/CallNotification/` - компонент уведомлений
- `client/src/App.jsx` - интеграция в главное приложение

## Логика определения пользователей

Система автоматически определяет:

- **Пользователей** по номерам в таблице `user_phones`
- **Дилеров** по номерам в таблице `dealer_phone_numbers`

### Приоритет определения:

1. Сначала ищется в таблице `user_phones`
2. Затем в таблице `dealer_phone_numbers`
3. Если не найден - отображается как "Неизвестный"

## Безопасность

- Аутентификация пользователей через WebSocket
- Проверка принадлежности номеров пользователям
- Валидация данных на сервере и клиенте

## Производительность

- Оптимизированные запросы к базе данных
- Кэширование информации о пользователях
- Эффективная обработка WebSocket событий
