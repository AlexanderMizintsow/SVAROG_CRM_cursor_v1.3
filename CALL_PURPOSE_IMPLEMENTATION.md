# Внедрение функциональности целей звонков

## Описание изменений

Добавлена возможность выбора цели звонка и ввода описания в модальном окне активного звонка. Пользователи могут выбирать из предустановленных целей или добавлять новые.

## Изменения в базе данных

### 1. Создание таблицы целей звонков

Выполните SQL скрипт из файла `db/call_purposes.sql`:

```sql
-- Таблица целей звонков
CREATE TABLE call_purposes (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);

-- Вставка базовых целей звонков
INSERT INTO call_purposes (name, description) VALUES
    ('Расчет', 'Вопросы по расчетам и ценообразованию'),
    ('Консультация', 'Общие консультации по продуктам и услугам'),
    ('Рекламация', 'Жалобы и претензии'),
    ('Бухгалтерия', 'Вопросы по бухгалтерским документам'),
    ('Логистика', 'Вопросы по доставке и логистике');

-- Добавление полей в таблицу calls
ALTER TABLE calls
ADD COLUMN purpose_id INTEGER REFERENCES call_purposes(id),
ADD COLUMN description TEXT,
ADD COLUMN updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW();

-- Создание индекса
CREATE INDEX idx_calls_purpose_id ON calls(purpose_id);

-- Триггер для автоматического обновления updated_at
CREATE OR REPLACE FUNCTION update_calls_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_calls_updated_at_trigger
BEFORE UPDATE ON calls
FOR EACH ROW EXECUTE FUNCTION update_calls_updated_at();
```

## Изменения в серверной части

### 2. Добавлены новые API endpoints в `server/CRM-server/index.js`:

- `GET /api/call-purposes` - получение списка целей звонков
- `POST /api/call-purposes` - добавление новой цели звонка
- `PUT /api/calls/:callId` - обновление звонка (цель и описание)
- `GET /api/calls/:callId/details` - получение деталей звонка с целью

## Изменения в клиентской части

### 3. Обновлен компонент `client/src/components/CallNotification/CallNotification.jsx`:

- Добавлены новые состояния для работы с целями звонков
- Добавлена загрузка целей звонков при инициализации
- Добавлена загрузка данных звонка при изменении callData
- Добавлены функции сохранения данных и добавления новых целей
- Добавлен UI для выбора цели звонка и ввода описания
- Добавлено модальное окно для добавления новых целей

## Функциональность

### Доступные цели звонков:

1. **Расчет** - Вопросы по расчетам и ценообразованию
2. **Консультация** - Общие консультации по продуктам и услугам
3. **Рекламация** - Жалобы и претензии
4. **Бухгалтерия** - Вопросы по бухгалтерским документам
5. **Логистика** - Вопросы по доставке и логистике

### Возможности:

- Выбор цели звонка из выпадающего списка
- Добавление новых целей звонков через модальное окно
- Ввод описания звонка в многострочном поле
- Сохранение информации о звонке
- Автоматическая загрузка сохраненных данных при открытии модального окна

### Когда доступна функциональность:

- Для активных звонков (`call_started`)
- Для завершенных звонков (`call_ended`)

## Порядок внедрения

1. **Выполните SQL скрипт** из файла `db/call_purposes.sql` в вашей базе данных
2. **Перезапустите CRM сервер** для применения новых API endpoints
3. **Перезапустите клиентское приложение** для применения изменений в UI

## Тестирование

1. Откройте модальное окно активного или завершенного звонка
2. Проверьте отображение формы "Информация о звонке"
3. Выберите цель звонка из выпадающего списка
4. Введите описание звонка
5. Нажмите "Сохранить информацию"
6. Проверьте добавление новой цели через кнопку "Добавить новую цель"

## Примечания

- Все изменения совместимы с существующей функциональностью
- Данные сохраняются в таблице `calls` с привязкой к конкретному звонку
- Новые цели можно добавлять динамически без перезапуска приложения
- Описание звонка является необязательным полем
